name: QR Queue Full CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  
  # ci-cd:
  #   runs-on: ubuntu-latest
  #   needs: test
  #   steps:
  #     # 1️⃣ Checkout code
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     # 2️⃣ Docker login
  #     - name: Log in to Docker Hub
  #       uses: docker/login-action@v2
  #       with:
  #         username: ${{ secrets.DOCKER_USERNAME }}
  #         password: ${{ secrets.DOCKER_PASSWORD }}

  #     # 3️⃣ Build Docker image
  #     - name: Build Docker image
  #       run: |
  #         IMAGE_TAG=${GITHUB_SHA::7}
  #         echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
  #         echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_ENV
  #         docker build -t ${{ secrets.DOCKER_USERNAME }}/qrqueue:$IMAGE_TAG .
  #         docker tag ${{ secrets.DOCKER_USERNAME }}/qrqueue:$IMAGE_TAG ${{ secrets.DOCKER_USERNAME }}/qrqueue:latest

  #     # 4️⃣ Push Docker images
  #     - name: Push Docker images
  #       run: |
  #         docker push ${{ secrets.DOCKER_USERNAME }}/qrqueue:$IMAGE_TAG
  #         docker push ${{ secrets.DOCKER_USERNAME }}/qrqueue:latest

  #     # 5️⃣ Configure AWS CLI
  #     - name: Configure AWS credentials
  #       uses: aws-actions/configure-aws-credentials@v2
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: ${{ secrets.AWS_REGION }}

  #     # 6️⃣ Start EC2 instance with SSH retry
  #     - name: Start EC2
  #       run: |
  #         INSTANCE_ID=${{ secrets.INSTANCE_ID }}
  #         aws ec2 start-instances --instance-ids $INSTANCE_ID
  #         aws ec2 wait instance-running --instance-ids $INSTANCE_ID
  #         echo "Waiting for SSH to be ready..."

  #         # Retry SSH up to 10 times
  #         for i in {1..10}; do
  #           ssh -o StrictHostKeyChecking=no -i /tmp/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo SSH ready" && break
  #           echo "SSH not ready yet, retry in 5s..."
  #           sleep 5
  #         done

  #     # 7️⃣ SSH deploy with retry and Docker improvements
  #     - name: SSH Deploy to EC2
  #       uses: appleboy/ssh-action@v0.1.9
  #       with:
  #         host: ${{ secrets.EC2_HOST }}
  #         username: ${{ secrets.EC2_USER }}
  #         key: ${{ secrets.EC2_SSH_KEY }}
  #         envs: IMAGE_TAG,DOCKER_USERNAME,DOCKER_PASSWORD
  #         script: |
  #           echo "Logging in to Docker Hub..."
  #           docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

  #           cd /home/${{ secrets.EC2_USER }}/qr-queue

  #           echo "Pruning dangling images..."
  #           docker image prune -f

  #           echo "Pulling Docker image: $IMAGE_TAG"
  #           docker pull ${DOCKER_USERNAME}/qrqueue:${IMAGE_TAG}

  #           echo "Stopping and removing old containers (if any)..."
  #           docker-compose down

  #           echo "Starting new containers via Docker Compose..."
  #           docker-compose up -d

  #     # # 8️⃣ Stop EC2 instance
  #     # - name: Stop EC2
  #     #   run: |
  #     #     INSTANCE_ID=${{ secrets.INSTANCE_ID }}
  #     #     aws ec2 stop-instances --instance-ids $INSTANCE_ID
  #     #     aws ec2 wait instance-stopped --instance