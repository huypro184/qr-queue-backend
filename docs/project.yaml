openapi: 3.0.3
info:
  title: QR Queue Backend - Projects
  version: "1.0.0"
servers:
  - url: http://localhost:3000
    description: Local dev

security:
  - bearerAuth: []

paths:
  /api/projects:
    post:
      tags: [Projects]
      summary: Create a new project
      description: Only superadmin can create project.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreateRequest'
      responses:
        "201":
          description: Project created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectResponse'
              examples:
                created:
                  value:
                    status: success
                    message: Project created successfully
                    data:
                      id: 123
                      name: "Main Office"
                      description: "Project description"
                      created_at: "2025-10-17T07:22:13.123Z"
        "400":
          description: Missing project name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: Please provide project name
        "409":
          description: Duplicate project name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: Project name already exists
        "500":
          $ref: '#/components/responses/InternalError'

    get:
      tags: [Projects]
      summary: Get list of projects
      description: Supports search + pagination.
      security:
        - bearerAuth: []
      parameters:
        - name: search
          in: query
          description: Search term for project name or description
          schema:
            type: string
        - name: page
          in: query
          description: Page number (default 1)
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Items per page (default 10)
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Projects retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Projects retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProjectWithServices'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
              examples:
                list:
                  value:
                    status: success
                    message: Projects retrieved successfully
                    data:
                      - id: 4
                        slug: "ea88a32d-9dbe-45e4-8fe8-8a26174d37bd"
                        name: "project 4"
                        description: "description"
                        created_at: "2025-09-12T16:30:07.374Z"
                        services:
                          - id: 18
                            name: "service 1"
                            description: "description"
                          - id: 19
                            name: "service 2"
                            description: "description"
                      # ... các project khác ...
                    pagination:
                      total: 4
                      page: 1
                      limit: 10
                      totalPages: 2
                      hasNext: true
                      hasPrev: false
        "500":
          $ref: '#/components/responses/InternalError'

  /api/projects/{id}:
    patch:
      tags: [Projects]
      summary: Update a project by id
      description: Only superadmin or admin (for their own project) can update.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectUpdateRequest'
      responses:
        "200":
          description: Project updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectUpdateResponse'
              examples:
                updated:
                  value:
                    status: success
                    message: Project updated successfully
                    data:
                      id: 123
                      name: "Main Office (renamed)"
                      description: "Updated description"
                      created_at: "2025-10-17T07:22:13.123Z"
                      users:
                        - id: 10
                          name: "Alice"
                          role: "admin"
                          status: "active"
        "400":
          description: Duplicate project name or invalid update
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                duplicate:
                  value:
                    status: fail
                    message: Project name already exists
                notfound:
                  value:
                    status: fail
                    message: Project not found
        "403":
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: You do not have permission to update this project
        "500":
          $ref: '#/components/responses/InternalError'

    delete:
      tags: [Projects]
      summary: Delete a project by id
      description: Cannot delete if project has users or services.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Project deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteProjectResponse'
              examples:
                deleted:
                  value:
                    status: success
                    message: Project deleted successfully
                    data:
                      id: 123
                      name: "Main Office"
        "400":
          description: Cannot delete project with users/services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                users:
                  value:
                    status: fail
                    message: Cannot delete project that has users. Please remove all users first.
                services:
                  value:
                    status: fail
                    message: Cannot delete project that has services. Please remove all services first.
        "403":
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: You do not have permission to delete this project
        "404":
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: Project not found
        "500":
          $ref: '#/components/responses/InternalError'

  /api/projects/{slug}:
    get:
      tags: [Projects]
      summary: Get service(s) by project slug
      description: Returns array of services for project.
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Service(s) retrieved for given project slug
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceListResponse'
              examples:
                services:
                  value:
                    status: success
                    message: Service retrieved successfully
                    data:
                      - id: 21
                        name: "Customer Service"
                        description: "Handles customer queue"
        "500":
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Project:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
      required: [id, name]

    ProjectWithServices:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        name:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
        services:
          type: array
          items:
            $ref: '#/components/schemas/Service'

    ProjectCreateRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string

    ProjectUpdateRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string

    ProjectResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          $ref: '#/components/schemas/Project'

    ProjectListResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: array
          items:
            $ref: '#/components/schemas/ProjectWithServices'
        pagination:
          $ref: '#/components/schemas/Pagination'

    ProjectUpdateResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
            description:
              type: string
            created_at:
              type: string
              format: date-time
            users:
              type: array
              items:
                $ref: '#/components/schemas/UserShort'

    DeleteProjectResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string

    Service:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string

    ServiceListResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: array
          items:
            $ref: '#/components/schemas/Service'

    UserShort:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        role:
          type: string
        status:
          type: string

    Pagination:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer
        totalPages:
          type: integer
        hasNext:
          type: boolean
        hasPrev:
          type: boolean

    Error:
      type: object
      properties:
        status:
          type: string
        message:
          type: string

  responses:
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            status: fail
            message: Internal server error