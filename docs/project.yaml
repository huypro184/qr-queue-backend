openapi: 3.0.3
info:
  title: QR Queue Backend - Projects
  version: "1.0.0"
servers:
  - url: http://localhost:3000
    description: Local dev

security:
  - bearerAuth: []

paths:
  /api/projects:
    post:
      tags: [Projects]
      summary: Create a new project
      description: Only superadmin can create project.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreateRequest'
      responses:
        "201":
          description: Project created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectResponse'
              examples:
                created:
                  value:
                    status: success
                    message: Project created successfully
                    data:
                      id: 123
                      name: "Main Office"
                      description: "Project description"
                      created_at: "2025-10-17T07:22:13.123Z"
        "400":
          description: Missing project name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: Please provide project name
        "409":
          description: Duplicate project name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: Project name already exists
        "500":
          $ref: '#/components/responses/InternalError'

    get:
      tags: [Projects]
      summary: Get list of projects
      description: Supports search + pagination.
      security:
        - bearerAuth: []
      parameters:
        - name: search
          in: query
          description: Search term for project name or description
          schema:
            type: string
        - name: page
          in: query
          description: Page number (default 1)
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Items per page (default 10)
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Projects retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Projects retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProjectWithServices'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
              examples:
                list:
                  value:
                    status: success
                    message: Projects retrieved successfully
                    data:
                      - id: 4
                        slug: "ea88a32d-9dbe-45e4-8fe8-8a26174d37bd"
                        name: "project 4"
                        description: "description"
                        created_at: "2025-09-12T16:30:07.374Z"
                        admin_id: 366
                        admin_name: "new35"
                        admin_email: "josh@gmail.com"

                      # ... các project khác ...
                    pagination:
                      total: 4
                      page: 1
                      limit: 10
                      totalPages: 2
                      hasNext: true
                      hasPrev: false
        "500":
          $ref: '#/components/responses/InternalError'

  /api/projects/unassigned/projects:
    get:
      tags: [Projects]
      summary: Get projects without admin
      description: |
        Returns list of projects that don't have an admin assigned yet.
        Supports search by project name or description.
        No pagination - returns all matching results.
      security:
        - bearerAuth: []
      parameters:
        - name: search
          in: query
          description: Search term for project name or description
          schema:
            type: string
          example: "hospital"
      responses:
        "200":
          description: Unassigned projects retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Unassigned projects retrieved successfully
                  data:
                    type: object
                    properties:
                      projects:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: integer
                              example: 1
                            name:
                              type: string
                              example: "Hospital Queue System"
                            description:
                              type: string
                              nullable: true
                              example: "Main hospital queue"
                      message:
                        type: string
                        nullable: true
                        example: null
              examples:
                withResults:
                  summary: Projects found
                  value:
                    status: success
                    message: Unassigned projects retrieved successfully
                    data:
                      projects:
                        - id: 1
                          name: "Hospital Queue System"
                          description: "Main hospital queue"
                        - id: 3
                          name: "Shopping Mall Queue"
                          description: "Mall queue"
                      message: null
                noResults:
                  summary: No unassigned projects
                  value:
                    status: success
                    message: Unassigned projects retrieved successfully
                    data:
                      projects: []
                      message: "No unassigned projects found"
        "403":
          description: Access denied - only superadmin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "500":
          $ref: '#/components/responses/InternalError'

  /api/projects/assign-project:
    post:
      tags: [Projects]
      summary: Assign project to admin by name
      description: |
        Assigns an unassigned project to an admin user.
        
        **Changes from previous version:**
        - Uses `projectName` (string) instead of `projectId` (integer)
        - Validates that project exists and doesn't have admin yet
        - Validates that user exists and has admin role
        
        Only superadmin can access this endpoint.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
                - projectName
              properties:
                userId:
                  type: integer
                  description: Admin user ID to assign project to
                  example: 5
                projectName:
                  type: string
                  description: Exact project name to assign
                  example: "Hospital Queue System"
      responses:
        "200":
          description: Project assigned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Project assigned to admin successfully
                  data:
                    type: object
                    properties:
                      project:
                        type: object
                        properties:
                          id:
                            type: integer
                            example: 1
                          name:
                            type: string
                            example: "Hospital Queue System"
                          description:
                            type: string
                            nullable: true
                            example: "Main hospital queue"
                          admin:
                            type: object
                            properties:
                              id:
                                type: integer
                                example: 5
                              name:
                                type: string
                                example: "John Admin"
                              email:
                                type: string
                                example: "john@example.com"
                              role:
                                type: string
                                example: "admin"
                          created_at:
                            type: string
                            format: date-time
                            example: "2025-11-01T10:00:00.000Z"
              examples:
                success:
                  summary: Assignment successful
                  value:
                    status: success
                    message: Project assigned to admin successfully
                    data:
                      project:
                        id: 1
                        name: "Hospital Queue System"
                        description: "Main hospital queue"
                        admin:
                          id: 5
                          name: "John Admin"
                          email: "john@example.com"
                          role: "admin"
                        created_at: "2025-11-01T10:00:00.000Z"
        "400":
          description: Bad request - missing or invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingParams:
                  summary: Missing required fields
                  value:
                    status: fail
                    message: userId and projectName are required
                invalidUserId:
                  summary: Invalid userId format
                  value:
                    status: fail
                    message: userId must be a valid number
        "404":
          description: Admin or project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                adminNotFound:
                  summary: Admin user not found
                  value:
                    status: fail
                    message: Admin user not found
                projectNotFound:
                  summary: Project not found or already assigned
                  value:
                    status: fail
                    message: Project not found or already has an admin
        "403":
          description: Access denied - only superadmin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        "500":
          $ref: '#/components/responses/InternalError'

  /api/projects/{id}:
    patch:
      tags: [Projects]
      summary: Update a project by id
      description: Only superadmin or admin (for their own project) can update.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectUpdateRequest'
      responses:
        "200":
          description: Project updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectUpdateResponse'
              examples:
                updated:
                  value:
                    status: success
                    message: Project updated successfully
                    data:
                      id: 123
                      name: "Main Office (renamed)"
                      description: "Updated description"
                      created_at: "2025-10-17T07:22:13.123Z"
                      users:
                        - id: 10
                          name: "Alice"
                          role: "admin"
                          status: "active"
        "400":
          description: Duplicate project name or invalid update
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                duplicate:
                  value:
                    status: fail
                    message: Project name already exists
                notfound:
                  value:
                    status: fail
                    message: Project not found
        "403":
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: You do not have permission to update this project
        "500":
          $ref: '#/components/responses/InternalError'

    delete:
      tags: [Projects]
      summary: Delete a project by id
      description: Cannot delete if project has users or services.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Project deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteProjectResponse'
              examples:
                deleted:
                  value:
                    status: success
                    message: Project deleted successfully
                    data:
                      id: 123
                      name: "Main Office"
        "400":
          description: Cannot delete project with users/services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                users:
                  value:
                    status: fail
                    message: Cannot delete project that has users. Please remove all users first.
                services:
                  value:
                    status: fail
                    message: Cannot delete project that has services. Please remove all services first.
        "403":
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: You do not have permission to delete this project
        "404":
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                status: fail
                message: Project not found
        "500":
          $ref: '#/components/responses/InternalError'

  /api/projects/{slug}:
    get:
      tags: [Projects]
      summary: Get service(s) by project slug
      description: Returns array of services for project.
      security:
        - bearerAuth: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Service(s) retrieved for given project slug
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceListResponse'
              examples:
                services:
                  value:
                    status: success
                    message: Service retrieved successfully
                    data:
                      - id: 21
                        name: "Customer Service"
                        description: "Handles customer queue"
        "500":
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Project:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
      required: [id, name]

    ProjectWithServices:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        name:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
        services:
          type: array
          items:
            $ref: '#/components/schemas/Service'

    ProjectCreateRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string

    ProjectUpdateRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string

    ProjectResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          $ref: '#/components/schemas/Project'

    ProjectListResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: array
          items:
            $ref: '#/components/schemas/ProjectWithServices'
        pagination:
          $ref: '#/components/schemas/Pagination'

    ProjectUpdateResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
            description:
              type: string
            created_at:
              type: string
              format: date-time
            users:
              type: array
              items:
                $ref: '#/components/schemas/UserShort'

    DeleteProjectResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string

    Service:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string

    ServiceListResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string
        data:
          type: array
          items:
            $ref: '#/components/schemas/Service'

    UserShort:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        role:
          type: string
        status:
          type: string

    Pagination:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer
        totalPages:
          type: integer
        hasNext:
          type: boolean
        hasPrev:
          type: boolean

    Error:
      type: object
      properties:
        status:
          type: string
        message:
          type: string

  responses:
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            status: fail
            message: Internal server error