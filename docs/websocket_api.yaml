openapi: 3.0.3
info:
  title: QR Queue WebSocket API
  version: 1.0.0
  description: |
    ## üì° Real-time Communication Documentation
    
    H·ªá th·ªëng s·ª≠ d·ª•ng **Socket.io** ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin v√© realtime cho kh√°ch h√†ng.
    
    ### Base URL
    ```
    http://localhost:3000
    ```
    
    ### K·∫øt n·ªëi
    
    **CDN:**
    ```html
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      const socket = io('http://localhost:3000');
    </script>
    ```
    
    **NPM:**
    ```bash
    npm install socket.io-client
    ```
    
    ```javascript
    import { io } from 'socket.io-client';
    const socket = io('http://localhost:3000');
    ```

servers:
  - url: http://localhost:3000
    description: Development server

tags:
  - name: WebSocket Events
    description: Socket.io real-time events

paths:
  /websocket/connect:
    post:
      tags:
        - WebSocket Events
      summary: K·∫øt n·ªëi Socket.io
      description: |
        Endpoint n√†y m√¥ t·∫£ c√°ch k·∫øt n·ªëi Socket.io (kh√¥ng ph·∫£i REST API endpoint th·ª±c s·ª±).
        
        **Lifecycle Events:**
        
        ### `connect` - K·∫øt n·ªëi th√†nh c√¥ng
        ```javascript
        socket.on('connect', () => {
          console.log('Connected:', socket.id);
          socket.emit('join_ticket', { ticketId: 191 });
        });
        ```
        
        ### `disconnect` - M·∫•t k·∫øt n·ªëi
        ```javascript
        socket.on('disconnect', (reason) => {
          console.log('Disconnected:', reason);
        });
        ```
        
        ### `connect_error` - L·ªói k·∫øt n·ªëi
        ```javascript
        socket.on('connect_error', (error) => {
          console.error('Error:', error);
        });
        ```
      responses:
        '200':
          description: Connection established
          content:
            application/json:
              schema:
                type: object
                properties:
                  socketId:
                    type: string
                    example: "abc123xyz"

  /websocket/join_ticket:
    post:
      tags:
        - WebSocket Events
      summary: "[CLIENT ‚Üí SERVER] Join v√†o room theo d√µi v√©"
      description: |
        Client g·ª≠i event n√†y ƒë·ªÉ tham gia room c·ªßa m·ªôt v√© c·ª• th·ªÉ.
        
        **Backend Code:**
        ```javascript
        // File: backend/services/websocket.js
        socket.on('join_ticket', (data) => {
          const { ticketId } = data;
          socket.join(`ticket_${ticketId}`);
          logger.info(`Client ${socket.id} joined ticket_${ticketId}`);
        });
        ```
        
        **Frontend Code:**
        ```javascript
        socket.emit('join_ticket', { ticketId: 191 });
        ```
        
        **Khi n√†o g·ªçi:**
        - Ngay sau khi `socket.on('connect')`
        - Khi kh√°ch h√†ng m·ªü trang xem v√©
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticketId
              properties:
                ticketId:
                  type: integer
                  description: ID c·ªßa v√© c·∫ßn theo d√µi (l·∫•y t·ª´ URL ho·∫∑c API response)
                  example: 191
      responses:
        '200':
          description: Join th√†nh c√¥ng (kh√¥ng c√≥ response tr·ª±c ti·∫øp, ch·ªâ c√≥ log)
          content:
            text/plain:
              schema:
                type: string
                example: "Client abc123xyz joined ticket_191"

  /websocket/ticket_updated:
    get:
      tags:
        - WebSocket Events
      summary: "[SERVER ‚Üí CLIENT] Nh·∫≠n c·∫≠p nh·∫≠t th√¥ng tin v√©"
      description: |
        Server t·ª± ƒë·ªông g·ª≠i event n√†y khi c√≥ thay ƒë·ªïi li√™n quan ƒë·∫øn v√©.
        
        **Khi n√†o ƒë∆∞·ª£c g·ª≠i:**
        
        | S·ª± ki·ªán | Backend Function | M√¥ t·∫£ |
        |---------|------------------|-------|
        | G·ªçi v√© ti·∫øp theo | `callNextTicket()` | V√© ƒë∆∞·ª£c g·ªçi + c√°c v√© c√≤n l·∫°i c·∫≠p nh·∫≠t th·ªùi gian |
        | H·ªßy v√© | `cancelTicket()` | V√© b·ªã h·ªßy + c√°c v√© c√≤n l·∫°i c·∫≠p nh·∫≠t th·ªùi gian |

        
        **Backend Code:**
        ```javascript
        // File: backend/services/ticketService.js
        
        // Case 1: C·∫≠p nh·∫≠t th·ªùi gian ch·ªù (function: notifyWaitingTickets)
        for (const ticket of waitingTickets) {
          io.to(`ticket_${ticket.id}`).emit('ticket_updated', {
            ticketId: ticket.id,
            waiting_time: ticket.waiting_time,
            status: ticket.status,
            message: 'Th·ªùi gian ch·ªù ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t'
          });
        }
        
        // Case 2: V√© ƒë∆∞·ª£c g·ªçi (function: callNextTicket)
        io.to(`ticket_${nextTicket.id}`).emit('ticket_updated', {
          ticketId: nextTicket.id,
          status: 'serving',
          message: 'ƒê·∫øn l∆∞·ª£t b·∫°n, vui l√≤ng ƒë·∫øn qu·∫ßy'
        });
        
        // Case 3: V√© b·ªã h·ªßy (function: cancelTicket)
        io.to(`ticket_${ticketId}`).emit('ticket_updated', {
          ticketId: ticketId,
          status: 'cancelled',
          message: 'V√© c·ªßa b·∫°n ƒë√£ b·ªã h·ªßy'
        });
        ```
        
        **Frontend Code:**
        ```javascript
        socket.on('ticket_updated', (data) => {
          console.log('Update:', data);
          
          // C·∫≠p nh·∫≠t UI
          if (data.waiting_time !== undefined) {
            document.getElementById('waitingTime').textContent = data.waiting_time + ' ph√∫t';
          }
          
          if (data.status === 'serving') {
            alert('üîî ƒê·∫øn l∆∞·ª£t b·∫°n!');
          }
          
          if (data.status === 'cancelled') {
            alert('‚ùå V√© ƒë√£ b·ªã h·ªßy');
          }
        });
        ```
      parameters:
        - name: ticketId
          in: query
          description: ID c·ªßa v√© (ch·ªâ ƒë·ªÉ minh h·ªça, th·ª±c t·∫ø l√† event payload)
          schema:
            type: integer
            example: 191
      responses:
        '200':
          description: Event payload ƒë∆∞·ª£c g·ª≠i t·ª´ server
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketUpdatedEvent'
              examples:
                waiting_time_updated:
                  summary: Th·ªùi gian ch·ªù thay ƒë·ªïi
                  value:
                    ticketId: 191
                    waiting_time: 12
                    status: "waiting"
                    message: "Th·ªùi gian ch·ªù ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t"
                
                ticket_called:
                  summary: V√© ƒë∆∞·ª£c g·ªçi ph·ª•c v·ª•
                  value:
                    ticketId: 191
                    status: "serving"
                    message: "ƒê·∫øn l∆∞·ª£t b·∫°n, vui l√≤ng ƒë·∫øn qu·∫ßy"
                
                ticket_cancelled:
                  summary: V√© b·ªã h·ªßy
                  value:
                    ticketId: 191
                    status: "cancelled"
                    message: "V√© c·ªßa b·∫°n ƒë√£ b·ªã h·ªßy"

components:
  schemas:
    TicketUpdatedEvent:
      type: object
      required:
        - ticketId
        - status
        - message
      properties:
        ticketId:
          type: integer
          description: ID c·ªßa v√© ƒë∆∞·ª£c c·∫≠p nh·∫≠t
          example: 191
        waiting_time:
          type: integer
          nullable: true
          description: Th·ªùi gian ch·ªù d·ª± ki·∫øn (ph√∫t) - ch·ªâ c√≥ khi status = 'waiting'
          example: 15
        status:
          type: string
          enum:
            - waiting
            - serving
            - done
            - cancelled
          description: |
            Tr·∫°ng th√°i v√© m·ªõi:
            - `waiting`: ƒêang ch·ªù
            - `serving`: ƒêang ph·ª•c v·ª•
            - `done`: Ho√†n th√†nh
            - `cancelled`: ƒê√£ h·ªßy
          example: "waiting"
        message:
          type: string
          description: Th√¥ng b√°o cho kh√°ch h√†ng
          example: "Th·ªùi gian ch·ªù ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t"

    JoinTicketRequest:
      type: object
      required:
        - ticketId
      properties:
        ticketId:
          type: integer
          description: ID c·ªßa v√© c·∫ßn theo d√µi
          example: 191

  examples:
    VanillaJSExample:
      summary: Vanilla JavaScript Example
      value: |
        <!DOCTYPE html>
        <html>
        <head>
          <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        </head>
        <body>
          <h1>V√© #<span id="ticketNumber">--</span></h1>
          <p>Th·ªùi gian ch·ªù: <span id="waitingTime">--</span> ph√∫t</p>
          
          <script>
            const ticketId = 191;
            const socket = io('http://localhost:3000');
            
            socket.on('connect', () => {
              console.log('Connected:', socket.id);
              socket.emit('join_ticket', { ticketId });
            });
            
            socket.on('ticket_updated', (data) => {
              if (data.waiting_time !== undefined) {
                document.getElementById('waitingTime').textContent = data.waiting_time;
              }
              if (data.status === 'serving') {
                alert('üîî ƒê·∫øn l∆∞·ª£t b·∫°n!');
              }
            });
          </script>
        </body>
        </html>
    
    ReactExample:
      summary: React Example
      value: |
        import { useEffect, useState } from 'react';
        import { io } from 'socket.io-client';
        
        function TicketView() {
          const [ticket, setTicket] = useState(null);
          const ticketId = 191;
          
          useEffect(() => {
            const socket = io('http://localhost:3000');
            
            socket.on('connect', () => {
              socket.emit('join_ticket', { ticketId });
            });
            
            socket.on('ticket_updated', (data) => {
              setTicket(prev => ({
                ...prev,
                waiting_time: data.waiting_time,
                status: data.status
              }));
              
              if (data.status === 'serving') {
                alert('üîî ƒê·∫øn l∆∞·ª£t b·∫°n!');
              }
            });
            
            return () => socket.disconnect();
          }, [ticketId]);
          
          return (
            <div>
              <h1>V√© #{ticketId}</h1>
              <p>Th·ªùi gian ch·ªù: {ticket?.waiting_time} ph√∫t</p>
            </div>
          );
        }